# Get the script's current directory
$scriptPath = Split-Path -Parent $MyInvocation.MyCommand.Definition
$allowedFile = Join-Path -Path $scriptPath -ChildPath "allowed.txt"
$resultsFile = Join-Path -Path $scriptPath -ChildPath "results.txt"
$bannerFile = Join-Path -Path $scriptPath -ChildPath "banner.txt"

# --- PART 1: Display the Banner in Notepad ---

$asciiArt = @"
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::::::::::----:-----------------------------------------------------------------------------==-==----------------=---==-==-==--=----------------------------------------------==-=
::------:--------------------------------------------------------------------=--=-===--===---==-=====================================-===============--======--===-------------==-=
-----------------------------------------------------------------------==-==--=====-====-=-==-==--====-==-===-===============================-===-======-==-====-======-=-=-===-==-
------------------------------------------------------------------=============--==-==-======-===============================================-====--==-==-==-======-======---==-==-
----=+=-=%%*=-------------------------------------------------==---=--=--=--==================-===================================================================-==-==-====-==-==
---#%%*==%%*+---------------------------------------------------=========================================================================================================-====-==-=
---#%%#==%##+=------=#*=-----------------------------------==---==--==-===============================================================================================--======-=-==
=--*%%#==%%%%=-----+%%*=-----------------------------------=====-===============================================================================================================-=-
%*-+%%%*=%%%%+=--==#%%*=----------------------------------==---==-=======================================================================================++======**+===========-===
%%=+%%%#=%%%%*=---+%%#+=-------------------------------=---=-==-=========================================================================================#*+=====#**==+*=========-=
%%=+%%%%+#%%%*==-=%%%*=------------------------------=--=======-=========================================================================================%#*=====%#*+=*#*========-=
%%*=%%%%+*%%%*===%%%#+=------------------------------=--==--=-==--=======================================================================================*%**====%%#+=+#*==========
%%%+%%%%=*%%%+=-*%%#*=----------------------------==--=---===-=====================+++**##+==============================================================+%%**===%%%*==##+==**==-==
%%%*%%%%%%%%%%##%%#*==--------------------------------======================+*%%%%%%%%%%##%#*+============================================================#%%#*+=%%%#+=%%*==*#+=-==
%%%%%%%%%%%%%%%%##*==-----------------------==-=======-==-================#%%%%%%###***%#******++=========================================================+%%%**=*%%#*=#%*==+#===-=
%%%%%%%%%%%%%%%%#*+=---------------------------==-==-===-================%%%%%%%%%##*********+==++++=======================================================+%%%%%%%##%%#**==*#===-=
%%%%%%%%%%%%%#****=----------------------==---==-==-====================%%%%%%%%%%#*****+++===---==+========================================================#%%%%%%%%%%%#%%#===-===
%%%%%%%%%%%###%#**+------------------------==-==-==-==================#%%%%%%%%%%%#*******++++==----========================================================*%%%%%%%%%%%%%%*=+===-=
%%%%%%%%%%%%%%%###*=--==+**+==----------=-====-==-===================#%%%%%%%%%%%#***********+===----=================================================+++===+%%#%%##%%%%%%%*#*=-===
%%%%%%%%%%%%%%%%%#%##%%%%%#**++=-----===--=--==-====================+%%%%%%%%%%%%#************+==---:-=============================================*##%#**+==**%%#++#%%%%%%%%#+==-=
%%%%%%%%%%%%%%%%%%%%%%%#*+=====-------=========-====================*%%%%%%%%%%%%#****#*#*****++==--::-=--========================================+#*====+++===***+=*%%%%%%%%%+==-=
%%%%%%%%%%%%%%%%%%%%#*===-----------=--==--==-======================#%%%%%%%%%%%%%%#**######***+==--:::::-==================================================+++***#**+-*%%%%%%+====
%%%%%%%%%%%%%%%%##**+=---=---=--==--===-============================*%%%%%%%%%%%%%%##*##%%%#***+++=-:::::-================================================++*********==-*%%%%*==-=-
#%%%##%%%%%%%##**==------=----=---=-================================+%%%%%%%%%##****+*#%#**++=======-:::--=++===+++++==+==+=====++==+===============+==++==++*+=+*#*+==-+%%%#+-===-
*##**#####****+=----=---=--=--======--===============================%%%%%%%#+=====++*##*==--==----:-:::-=+++++==++=+++++++++===++=++==+=++=====+====+++++++++*++**++*==*=*%*=-==-=
#%%%%%%%%#**==------=-=---====-==-===================================%%%%%%#*++*+=+++*%%*--=+++====-::-::-=+=+++++++=++=++=+++++++++=+===+++++++++++++++++++++=******+==++**==--===
%%%%%%%###*=-----------====-==-==-=-================================*%%%%%%*++==-=+*#%%##+-+*#*++==-::::-:=+++++++++++++++++++++++++++++++++=++=++++++++++++++++##******##**+=:==-=
%%%%%%%###+=--=-==--==--==-==-==-==================================*##%%%%%*%%**#***###%#=--+***++-:::-::-+++++++++++++++++++++++++++++++++++++++++++++++++++++++#***##%%%**+=-==-=
%%%%%%%#**+=------=======-==-======================================**%%%%%%%%#***+*###%%%#+--***+====:-::-++++++++++++++++++++++++++++++++++++++++++++++++++++++++#%%%%%%#**++--===
%%%%%%%***+=--=====--====-=========================================+#%#%%%%%%#***####%%%%%*=-=*****+-::---++++++++++++++++++++++++++++++++++++++++++++++++++++++++**+===--:::::==-=
****+++=--:::-==-====--=============================================*%%%%%%%#***#%#*%%%##*=----=+++=-:--:-+++++++++++++++++++++++++++++++++++++++++++++++++++++++=:::::::::::::==-=
*****++=---::-==-=-==================================================##%%%%%#**%%**#%*++=--:::::-===-:--:=++++++++++++++++++++++++++++++++++++++++++++++++++++++++-:-:-:::::::-=-==
****+++=--:::-====-==================================================+%#%%%%#%%***##%%##**+=-::::-=-::::-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++=+********+====-
****++==--:::--=======================================================%%%%%%%%****######***++=-=-==-:-:-=++++++++++++++++++++++++++++++++**++*++*+++++++++++++**+++=========----===
****++==-::::--=-=====================================================+#*%%%###***++++***++==--=+*=:::-++++++++++++++++++++++++**++*****++****+++**++*+++++*++==========---=-=
***+======--::-==========================================================*%%##%*+*##%%%###**+===**=:::=+++++*+*++*++******+**++*************+***+****++**++*******+==========--==-=
-=-------:::::-===========================================================*%###**#*###%%##*+===-=+-::=++++++++*******+*++*******+**+****************************+++==========--====
==-=-----:::::-===========================================================+%%****####%###**+===---:::=++++*******+************************************************=---=======--=-=-
====-=---:::::-==========================================================**%%%***+******+==-::::::::::=++*++**+***************************************************=-----------==-==
--==-----:::::=========================================================*%#=%#***+---==-------::::::::::-=++++*****************************************************=-----------=-===
-=--==--::::::-=====================++===++++++**+++++++++******++++*##*#+:=**=+**+++=++==:::::::::::::::::-=++***************************************************=------------==-=
----=----:::::-===========+%%%%%%%***=-=*+**+**+**+++++=+++++*++*********=::=***##*+==+*+=---::::::::::::::::::-+*****==--::::::-==--=****************************=-------=-----===
=-=----:::::::-==========*%%%%%%%***+--=+==============+======++===+++***=::--*#%**##*==::::::::::::::::::::::---:--::::::::::::::::::=***************************=-----==------==-
-------:::::::-=========*%%%%%%%=+++=-====---====----===------=======++*=:::--*#*****=::=-::::::--:-------:-::::-:-:::::::---:-:-:::-:::-=************************=------=-----==-=
-----:-:::::::-=========#%%%%%%%+===--==-----=--------==---=--------===+=::---*****=::::==----=--==-----:--::::-:--:::::::::--:::::::--::::=*+*******************+---------:----===
------::-::::::=========%%%%%*===+===-==--------:-----=-----:------:-===::----=**+=-::-==-::===-==--::-:--:--::---:::::::::-----:---::-::::-===+*****************+------=------==--
:-----:::::::::--------:-=========+==:==--:::::-::----==----:-=------===::-=--=++-::-=====-:-====-:-------::::-:--::::-::::-::----::::--:::::::-*****************+--:-----:-----===
:--:::::::---:::::::::::--:-===---:-=-===---:--:::-:---=---------=----==::=+*+=-::-===-===-=====-:-=------:-:::--:::::-----::--::--:::--::-::::::-====++*********+---------:-:-==-=
:--::-:--=--::::::::::==--=-====-::---===:-:::::-----------------=--===::-*=--::-====--==========:-*+=-----::-:--::::-------::-:-:::::--:--::----:::::::::-=+****=---------:::-=-==
:--------::::::::::-=--==---=-----::--===---:::------:--=-=----=======-::+=-::--===---======+=+=*==**==---::--:-::::::::-----:::::::::::--:--:----::--:--------:---:--=-:-:-:::===-
:::------::::::::::==-:----:----:::::-===-::::-::-::-----------=-=====-:==----====---=========+=*==*+===--::--:-:::-------:-:::::::::::-::----::--------------:::--::-:---::::--===
:::--:::-::::::::--=---:---::::-:::::-===--:-::-::::-:---:-----====+=::==----====--=============*==**====--===-:::---=-----::::::::::::::--:::------:::::-------::::-:::-:::::--=-=
-:------:::--::-------::::::::::-:::::===-----:::::::----:---:-======::==-===+=---==============+==+*====-=-==--:::----:---::::-::::::::--::--------------------:-::-::::::::::==-=
------::::=-::-=--------::::::::-::::-==-----:-:::-:---------:-=====-:-=-====---===================**====-====-::--:---::-::-:::::::::::::::::::--:::-:--------::::::----::::::-===
-::::::---:::-=:::::::--:::::::::-:::--=-------::::::------:-:-=====-:======-==============::======+*===-=====-:::-::-------:::::::::::::::::::--:::::-------:::---::::---::::--==-
--:-==--::::=-:::::::::::::::::::::::---==--::::-:-:---------:--===--:==============================*==-=====-:::---:----:-::-::::::::::::::::::::::::::::-:--:-::--:::::::-::--===
###+-::::::-:::::::::::::::::::::::::---=-----:-:-:-----------:-===-::====================++++==--==*=======-::::----:----::::::::::::::::::::::::--:::::::--:-:::-:---:-:---:-=--=
=------:::::::::::::::::::::::::::::----==---:::-::----:------:--==::=============--============-===*+====+=:::::----::--:--::::::::::::::::::::--::::::::::::---:-::::::-:-::--==-
-------:::::::::::::::::::::::::::::---------:-::::-:-::----==--===========++=::--=*+===============+========-=====-::::::::::::::::::::::::::-::::::::::::::::--=+***#%%%%%##*===-
:------:::--====::::::::::::::::::::-:----==-=-----::::::--=%%*--*%%*%%#-%%*+%%=+%%*#%#-%%===-%%+=-%%=**%%#***%#***=-:::::::::::::::::::::::::::::::::::::::=*###**%%%%%%###**+=-==
:-------:::-==+*+=+**+=-:::::::::::---------=------::---:-=%%*%=-*%*=*%*-%%%*=--%%===*%=%%===-%%===%%===%%-::*%*===:---:::::::::::::::::::::::::::::::::::+####**%%%%%%%##**+===-==
--------:::-==+*+===**%%+=-::::::::-:-----=---------------%%*+%%:*%*=+%%==-=#%%=%%-=-*%=%%=::-%%==-%%=+=%%-::*%*++=-:--:::::::::::::::::::::::::::::::-::*####**#%%%%%%##**+=====--
---------::--==++====*%*==-::::::::::-------------::-::-:+%%***%#*%#+*%%=%%+=%%+*%%=*%%-%%*++=+%#=*%%=++%%-::*%*+++=----::-::::::::::::::::::::::::::-::=####***%%%%%%###**========
---------::--==+==---+#+==--::::::-::----=-------::--:-:---::-:------------++=::::=+=======---===++-====--:::-------:----:---::::::::::::::::::::::::::-***#***#%%%%%##***+=====-==
---------:::--====----===-::::::::::------:-----:::::------:::::::::==================--==--=-===-======::::::::::-:---:-::---:::::::::::::::::::::::::********%%%%%##****=======--
---------:::---==-::::::-=-::::-=+**+==---------=-==---=-==---:::::-=============================--======-:---::-::-:-====-=--:::::::::-----::::::::::=********%%%%##****+=========
---------::::-----::::::::::=%%%%%%%%%%%%=----:+%%%%#--==%%%%%#:::=====%%%%%====#%%%%%%%%%%%%%%%+:-%%%%%%%--=--::-:--%%%%%%%=----:::::*%%%%%=:::::::::+*******#%%%###****======--==
:--------:::::---::::::::::%%%%%%%%%%%%%%%%---:+%%%%#-=-=%%%%%%%:======%%%%%====#%%%%%%%%%%%%%%%+--%%%%%%%%------:-:*%%%%%%%=::::::::-%%%%%%%:::::::::********%%%%##****+========-=
::-------::::::::::::::::-%%%%%#-:-::-#%%%%#:::+%%%%#---=%%%%%%%%======%%%%%====#%%%%*===========--%%%%%%%%+------:=%%%%%%%%-::::::::%%%%%%%%#::::::::*******#%%%###****+=====-==-=
::-----::::::::::::::::::*%%%%*-::::::-%%%%%=::+%%%%#---=%%%%%%%%%=====%%%%%====#%%%%*===+=-----==-%%%%%%%%%:-----:%%%%%%%%%-:::::::*%%%%#%%%%=:::::::*******%%%%##*****+=====-====
::::::::::::::::::::::::-%%%%%=::--:--:-::::::-*%%%%#---=%%%%%%%%%%====%%%%%====#%%%%*==--::::-=-=-%%%%%#%%%%--:::*%%%%*%%%%-::::::=%%%%#:%%%%%-:::::-******#%%%##*****+=====--=-==
::::::::::::::::::::::::=%%%%%-:::::---:--:::--*%%%%*----%%%%%=%%%%%+==%%%%%=--:#%%%%%%%%%%%%%%===-%%%%%=%%%%=:::=%%%%=*%%%%=::::::%%%%%-:=%%%%%:::::-******%%%%##****++=====--==-=
::::::::::::::::::::::::=%%%%%:::::-:--:--:::--+%%%%*-::-%%%%%==%%%%%+-%%%%%====#%%%%%%%%%%%%%%=-=-%%%%%:=%%%%-::%%%%*:%%%%%-:::::*%%%%*:::*%%%%=:::::=*****%%%##*****+=====-==-=
::::::::::::::::::::::::-%%%%%-::-:--:::::::---+%%%%*:::=%%%%%---#%%%%+%%%%%=:::#%%%%***=--::::::::%%%%%-:%%%%#:*%%%%::%%%%%-::::=%%%%%:::::%%%%%-:::::+***+%%%##*****+====----====
:::::::::::::::::::::::::%%%%%=::::::--*####=-:+%%%%*:-:-%%%%%-===*%%%%%%%%%===:#%%%%*:::::::::::::%%%%%-::%%%%=%%%%=::%%%%%=::::%%%%%%%%%%%%%%%%#:::::=**++#%##*****++=-=------==-
:::::::::::::::::::::::::=%%%%%::::---=%%%%%=-:*%%%%*:::-%%%%%-::::+%%%%%%%%===-#%%%%*:::::::::::::%%%%%-::=%%%%%%%*:::%%%%%-:::#%%%%%%%%%%%%%%%%%*::::=**++#%#******++==------==-=
::::::::::::::::::::::::::*%%%%%*=--=%%%%%%=---*%%%%*:::-%%%%%:::--:+%%%%%%%=:::#%%%%#++++++++++-::%%%%%-:::%%%%%%%::::%%%%%-::=%%%%%::::::::-%%%%%-:::=*+++#%#*++**+++==------==-=
:::::::::::::::::::::::::::=%%%%%%%%%%%%%%---::+%%%%*:::-%%%%%:::::::=%%%%%%=:::#%%%%%%%%%%%%%%%+::%%%%%-::::%%%%%=::::%%%%%=:-%%%%%+:::::::::*%%%%%:::=++++##**+++*+++-=-------==-
:::::::::::::::::::::::::::::-*%%%%%%%%*----:::+%%%%*:::=%%%%%::::::::-%%%%%=:::#%%%%%%%%%%%%%%%+::%%%%%-::::+%%%*:::::%%%%%-:*%%%%%:::::::::::%%%%%*::++++=##**+++*===---------==-
:::::::::::::::::::::::::::::::::::::::---::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-*+++=****+++=---------:-==-=
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::=+++==***+++-=--------::-==-=
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::++++==+**++=:---------::-=-==
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::+++==:+**+=::--------:::-===-
"@

# Write ASCII art to a file and open with Notepad
Set-Content -Path $bannerFile -Value $asciiArt
Start-Process notepad.exe -ArgumentList $bannerFile

# Wait a moment for notepad to open
Start-Sleep -Seconds 2

# --- PART 2: Helper Functions ---

function Get-RandomPassword {
    param ( [int]$Length = 15 )
    # Define character sets for complexity requirements
    $upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    $lower = "abcdefghijklmnopqrstuvwxyz"
    $numbers = "0123456789"
    $special = "!@#$%^&*()" # Standard Windows allowed specials
    
    $charSet = $upper + $lower + $numbers + $special
    $rng = New-Object System.Random
    
    # Ensure at least one of each mandatory type is included
    $password = New-Object System.Text.StringBuilder
    $password.Append($upper[$rng.Next($upper.Length)]) | Out-Null
    $password.Append($lower[$rng.Next($lower.Length)]) | Out-Null
    $password.Append($numbers[$rng.Next($numbers.Length)]) | Out-Null
    $password.Append($special[$rng.Next($special.Length)]) | Out-Null
    
    # Fill the rest randomly
    for ($i = 4; $i -lt $Length; $i++) {
        $password.Append($charSet[$rng.Next($charSet.Length)]) | Out-Null
    }
    
    # Shuffle the result to mix the mandatory characters
    $finalPass = $password.ToString().ToCharArray() | Sort-Object {Get-Random}
    return -join $finalPass
}

# --- PART 3: User Auditing ---

# Initialize results file
if (Test-Path $resultsFile) { Remove-Item $resultsFile }
New-Item -Path $resultsFile -ItemType File | Out-Null
Add-Content -Path $resultsFile -Value "--- USER AUDIT LOG ---"
Add-Content -Path $resultsFile -Value "Timestamp: $(Get-Date)"
Add-Content -Path $resultsFile -Value "----------------------"

# Check if allowed.txt exists
if (-not (Test-Path $allowedFile)) {
    Write-Error "allowed.txt not found at $allowedFile"
    exit
}

# Read allowed users (normalize to lowercase for comparison)
$allowedUsers = Get-Content $allowedFile | ForEach-Object { $_.Trim().ToLower() }

Write-Host "Starting User Audit..." -ForegroundColor Cyan

# Get all local users
$allUsers = Get-LocalUser

foreach ($user in $allUsers) {
    $userNameLower = $user.Name.ToLower()

    # Step 1: Compare and Disable
    if ($allowedUsers -contains $userNameLower) {
        $msg = "User check: [$($user.Name)] - ALL GOOD (Allowed)"
        Write-Host $msg -ForegroundColor Green
        Add-Content -Path $resultsFile -Value $msg
    }
    else {
        try {
            # Attempt to disable
            Disable-LocalUser -Name $user.Name -ErrorAction Stop
            $msg = "User check: [$($user.Name)] - NOT ALLOWED. Account Disabled."
            Write-Host $msg -ForegroundColor Red
            Add-Content -Path $resultsFile -Value $msg
        }
        catch {
            $msg = "User check: [$($user.Name)] - NOT ALLOWED. Failed to disable (Error: $($_.Exception.Message))"
            Write-Host $msg -ForegroundColor Yellow
            Add-Content -Path $resultsFile -Value $msg
        }
    }
}

Add-Content -Path $resultsFile -Value "`r`n--- REMAINING USERS & CREDENTIALS ---"

# --- PART 4: Group Audit and Password Reset ---

# Fetch enabled users again
$enabledUsers = Get-LocalUser | Where-Object { $_.Enabled -eq $true }

foreach ($user in $enabledUsers) {
    # Step 2: Check Admin Status
    $isAdmin = $false
    # Get members of Administrators group
    $adminGroup = Get-LocalGroupMember -Group "Administrators"
    
    # Check if this user is in the admin group (Format is usually COMPUTERNAME\User)
    if ($adminGroup.Name -contains "$env:COMPUTERNAME\$($user.Name)" -or $adminGroup.Name -contains $user.Name) {
        $isAdmin = $true
    }
    
    $adminStatus = if ($isAdmin) { "YES (Administrator)" } else { "NO" }
    
    # Step 3: Password Change
    $newPassword = Get-RandomPassword
    $securePassword = ConvertTo-SecureString $newPassword -AsPlainText -Force
    
    try {
        Set-LocalUser -Name $user.Name -Password $securePassword -ErrorAction Stop
        $passResult = "Password Changed: $newPassword"
    }
    catch {
        $passResult = "Password Change FAILED: $($_.Exception.Message)"
    }

    # Log details
    $logEntry = "User: $($user.Name) | Admin: $adminStatus | $passResult"
    Write-Host "Processing $($user.Name)..." -ForegroundColor Cyan
    Add-Content -Path $resultsFile -Value $logEntry
}

Write-Host "Script Complete. Results saved to $resultsFile" -ForegroundColor Green